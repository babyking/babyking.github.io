---
typora-root-url: ../
typora-copy-images-to: ../image
layout: post
title: 理解GCD
date: 2019-10-28 21:53
category: 开发 
tags: [gcd]
---



>理解要点
>
>1. 队列有两种,串行和并行,队列的理解主要就是任务的供给方式.串行同时只能提供一个任务,并行同时可以提供多个任务(如果有多个任务的话,如果当前队列只有一个任务,就跟串行一样了). 串行跟并行队列跟执行多个任务并不直接相关,执行单个还是多个任务是由执行任务的同步和异步来决定
>
>2. 执行任务分为同步和异步. 
>
>   同步执行,在当前线程(不新建线程),无论是在串行还是并行,都只能一个一个执行任务,一个执行完下再执行一下个任务
>
>   异步,新建线程,新建线程的数量取决于提供任务的队列,如果是串行队列,那就新建一个线程,并且开始顺次执行队列中的任务.  能否确认这里的顺次执行等同于同步执行串行队列? 除了是新建线程
>
>   能等同,因为为了执行这个串行队列中的任务,新开了线程,这里的异步主要就是体现在新建的线程相对于主线程来说的
>
>   同步和异步的理解
>
>   同步一个串行线程和并行线程基本没区别,区别最多的情况就是多个任务在串行和并行队列中的排列不同,而导致执行时候的顺序有可能不同.
>
>   异步一个串行线程和并行线程有区别,异步一个串行线程是开一个新线程来执行串行队列任务,而异步一个并行线程是开多个线程同时执行
>
>   异步是相对于当前的主线程来讲的.
>
>3. 死锁
>
>   死锁的根本原因就是你等我,我等你,最后等死.
>
>   同步加入一个任务A至串行队列,如果这时候发现当前线程正在执行任务就是暂停调度队列中的任务(包括加入任务),等待当前线程空闲时再恢复调度,而当前的同步加入一个任务A因为暂停调度队列也就没办法执行完而阻塞. 这样两边就都在等对方,   队列因主线程的正在忙事情(加入任务到队列)暂停调度然后等主线程空闲,主线程等队列恢复调度好完成自己的任务加入,互相等对方.
>
>   
>
>   ```objc
>   - (void)syncMain{
>       
>       dispatch_queue_t queue = dispatch_get_main_queue();
>       
>       NSLog(@"taskA-%@",[NSThread currentThread]);
>       
>       dispatch_sync(queue, ^{
>           NSLog(@"taskB-%@",[NSThread currentThread]);
>       });
>       
>       NSLog(@"taskA-End-%@",[NSThread currentThread]);
>   }
>   
>   
>   ```
>
>   syncMain 本身就是main_queue里的一个任务,姑且叫A,这个A任务执行过程中又往main_queue里加入了同步任务B,因为是同步的, 所以这个时候A必须等着B执行完成,才能继续执行A并结束,而B是在串行队列min_queu中后加进去的任务,必须等到前面的任务A执行完才能执行,死锁就产生了.
>
>   死锁产生的条件就是  一个串行队列中的同步任务在执行过程中,又往这个串行队列中加了另一个另步任务,这两个任务都在等着对方完成才能继续.这就是死锁.
>
>   
>
>   当前UI主线程执行的任务就是 dispatch_get_main_queue 这个队列里的任务,这个容易被忽略 
>



## 先上结论

### 队列

队列用来调度任务,也可以简单理解为如何提供任务.分为串行和并发队列两种.

1. 串行队列是按顺序提供任务的,当前一个任务完成后,才能提供下一个任务.任务的执行及完成是有先后顺序的.
2. 并发队列队列中其实也是按顺序提供任务的,只是下一个任务的提供并不依赖于前一个任务的执行完成,所以看起来提供任务是并发的.

> 队列本身不做新建线程来执行任务,就是简单的把队列理解为一个存储任务的容器好了. 这样理解不知道会不会有问题?

### 同步和异步

同步和异步是如何执行队列里的任务的行为,不同的队列对任务的执行有不同的影响.

* 同步

  在当前线程(不新建线程)执行队列中的任务,这里无论是串行还是并发队列,都是任务执行完了才能继续往下走. 同步情况下串行和并发队列行为一至,决定同步行为的是同步操作,不是队列的类型.

* 异步

  新建线程执行队列中的任务. 分两种情况:

  **串行队列**,新建一个线程,对串行队列中的任务依次顺序执行(如果有多个任务的话)

  **并发队列**,从对列中`依次`取n个任务,并开启n个线程执行任务. 

### 同异步和队列的关系 

* 串行队列可以控制任务执行完成先后顺序,无论这个任务是在当前线程,还是另外一个线程.

* 同步可以`控制`当前线程执行任务的先后顺序,无论这个任务是在串行队列还是并发队列.

* 并发队列可以`依次` `很快` 提供更多任务

* 异步可以根据队列提供的任务来新建线程云执行任务

上面这些描述可以得出**同步或异步与不同队列的描述可以提供不同的任务执行策略**.

1. 同步+串行队列
2. 同步+并发队列
3. 异步+串行队列
4. 异步+并发队列

**同步+串行队列**

这种情况其实用的很少,一般不这么用,如果一定要这么用,一定要避免在当前的任务中又加入新的任务到同一个串行队列,这样就会造成死锁.原因很简单.

![screenshot_20191022_141523 20](/image/screenshot_20191022_141523 20.png)

**同步+并发队列**

任务执行顺序效率跟上面一样,但不会有死锁的问题了.

**异步+串行队列**

新开一个线程,所有的任务在这个新开的线程里串行同步执行

**异步+并发队列**

这个提供了最大的并发,并且对同步没有什么要求和控制.



### 死锁

死锁

